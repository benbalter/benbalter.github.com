---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import { siteConfig } from '../config';

const title = 'Posts';
const description = siteConfig.description;

// Get all published posts (excluding archived), sorted by date (newest first)
const allPosts = await getCollection('posts', ({ data }: CollectionEntry<'posts'>) => {
  return data.published !== false && data.archived !== true;
});

// Sort posts by slug (which contains date in Jekyll format YYYY-MM-DD)
const posts: CollectionEntry<'posts'>[] = allPosts.sort((a: CollectionEntry<'posts'>, b: CollectionEntry<'posts'>) => 
  b.slug.localeCompare(a.slug)
);

// Helper function to parse date from slug
function getDateFromSlug(slug: string): Date {
  const match = slug.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if (match) {
    return new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
  }
  return new Date();
}

// Helper function to format date like Jekyll: "Month Day, Year"
function formatDate(date: Date): string {
  const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                  'July', 'August', 'September', 'October', 'November', 'December'];
  return `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
}

// Helper function to generate Jekyll-style URL from slug
function getPostUrl(slug: string): string {
  const match = slug.match(/^(\d{4})-(\d{2})-(\d{2})-(.+)$/);
  if (match) {
    const [, year, month, day, postSlug] = match;
    return `/${year}/${month}/${day}/${postSlug}/`;
  }
  return `/posts/${slug}/`; // fallback
}
---

<BaseLayout title={title} description={description} hero={true}>
  <div class="container-fluid px-3">
    {posts.map((post) => {
      const postDate = getDateFromSlug(post.slug);
      const postUrl = getPostUrl(post.slug);
      return (
        <div class="row mb-2">
          <div class="col-sm-9">
            <a href={postUrl}>{post.data.title}</a>
          </div>
          <div class="col-sm-3 text-muted text-md-end">
            <small>{formatDate(postDate)}</small>
          </div>
        </div>
      );
    })}
  </div>
</BaseLayout>

<style>
  .row {
    display: flex;
    flex-wrap: wrap;
    margin-right: 0;
    margin-left: 0;
  }

  .col-sm-9 {
    flex: 0 0 auto;
    width: 75%;
    padding: 0;
    padding-right: 0.5rem; /* Add spacing between title and date */
  }

  .col-sm-3 {
    flex: 0 0 auto;
    width: 25%;
    padding: 0;
  }

  .text-muted {
    color: #6c757d !important;
  }

  .text-md-end {
    text-align: right;
  }

  .mb-2 {
    margin-bottom: 0.5rem !important;
  }

  @media (max-width: 768px) {
    .col-sm-9,
    .col-sm-3 {
      width: 100%;
    }
    
    .text-md-end {
      text-align: left;
    }
  }
</style>
