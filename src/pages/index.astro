---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import { siteConfig } from '../config';

const title = 'Posts';
const description = siteConfig.description;

// Get all published posts (excluding archived), sorted by date (newest first)
const allPosts = await getCollection('posts', ({ data }: CollectionEntry<'posts'>) => {
  return data.published !== false && data.archived !== true;
});

// Sort posts by slug (which contains date in Jekyll format YYYY-MM-DD)
const posts: CollectionEntry<'posts'>[] = allPosts.sort((a: CollectionEntry<'posts'>, b: CollectionEntry<'posts'>) => 
  b.slug.localeCompare(a.slug)
);

// Helper function to parse date from slug
function getDateFromSlug(slug: string): Date {
  const match = slug.match(/^(\d{4})-(\d{2})-(\d{2})/);
  if (match) {
    return new Date(parseInt(match[1]), parseInt(match[2]) - 1, parseInt(match[3]));
  }
  return new Date();
}

// Helper function to format date like Jekyll: "Month Day, Year"
function formatDate(date: Date): string {
  const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                  'July', 'August', 'September', 'October', 'November', 'December'];
  return `${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
}

// Helper function to generate Jekyll-style URL from slug
function getPostUrl(slug: string): string {
  const match = slug.match(/^(\d{4})-(\d{2})-(\d{2})-(.+)$/);
  if (match) {
    const [, year, month, day, postSlug] = match;
    return `/${year}/${month}/${day}/${postSlug}/`;
  }
  return `/posts/${slug}/`; // fallback
}
---

<BaseLayout title={title} description={description} hero={true}>
  <ul class="list-unstyled p-0 m-0">
    {posts.map((post) => {
      const postDate = getDateFromSlug(post.slug);
      const postUrl = getPostUrl(post.slug);
      return (
        <li class="post-item py-3 border-bottom">
          <div class="row g-0">
            <div class="col-md-9">
              <div class="mb-1">
                <a href={postUrl} class="fs-5 fw-semibold text-body text-decoration-none">{post.data.title}</a>
              </div>
            </div>
            <div class="col-md-3 text-md-end">
              <small class="text-body-secondary">{formatDate(postDate)}</small>
            </div>
          </div>
        </li>
      );
    })}
  </ul>
</BaseLayout>
