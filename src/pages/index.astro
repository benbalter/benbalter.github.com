---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import { siteConfig } from '../config';
import { getPostUrl, getDateFromSlug, formatPostDate } from '../utils/post-urls';
import { calculateReadingTime } from '../utils/reading-time';
import FeaturedPostCard from '../components/FeaturedPostCard.astro';
import PostCard from '../components/PostCard.astro';

const description = siteConfig.description;

// Get all published posts (excluding archived), sorted by date (newest first)
const allPosts = await getCollection('posts', ({ data }: CollectionEntry<'posts'>) => {
  return data.published !== false && data.archived !== true;
});

// Sort posts by slug (which contains date in Jekyll format YYYY-MM-DD)
const posts: CollectionEntry<'posts'>[] = allPosts.sort((a: CollectionEntry<'posts'>, b: CollectionEntry<'posts'>) => 
  b.slug.localeCompare(a.slug)
);

// Split into featured (top 3) and regular posts
const featuredPosts = posts.slice(0, 3);
const regularPosts = posts.slice(3);
---

<BaseLayout description={description} hero={true}>
  <!-- Featured Posts Section -->
  {featuredPosts.length > 0 && (
    <section class="mb-5">
      <h2 class="h4 mb-4">Recent Posts</h2>
      <div class="row g-4">
        {featuredPosts.map((post) => {
          const postDate = getDateFromSlug(post.slug);
          const postUrl = getPostUrl(post.slug);
          const readingTime = calculateReadingTime(post.body);
          return (
            <div class="col-12 col-md-6 col-lg-4">
              <FeaturedPostCard
                title={post.data.title}
                url={postUrl}
                date={formatPostDate(postDate)}
                description={post.data.description}
                readingTime={readingTime}
              />
            </div>
          );
        })}
      </div>
    </section>
  )}

  <!-- Older Posts Section -->
  {regularPosts.length > 0 && (
    <section>
      <h2 class="h5 text-body-secondary mb-3">Older Posts</h2>
      <div class="row g-3">
        {regularPosts.map((post) => {
          const postDate = getDateFromSlug(post.slug);
          const postUrl = getPostUrl(post.slug);
          const readingTime = calculateReadingTime(post.body);
          return (
            <div class="col-12 col-md-6">
              <PostCard
                title={post.data.title}
                url={postUrl}
                date={formatPostDate(postDate)}
                description={post.data.description}
                readingTime={readingTime}
              />
            </div>
          );
        })}
      </div>
    </section>
  )}
</BaseLayout>
