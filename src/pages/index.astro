---
import BaseLayout from '../layouts/BaseLayout.astro';
import { getCollection, type CollectionEntry } from 'astro:content';
import { siteConfig, popularPostSlugs } from '../config';
import { getPostUrl, getDateFromSlug, formatPostDate, formatISODate } from '../utils/post-urls';
import { calculateReadingTime } from '../utils/reading-time';
import FeaturedPostCard from '../components/FeaturedPostCard.astro';
import PostCard from '../components/PostCard.astro';

const description = siteConfig.description;

// Get all published posts (excluding archived), sorted by date (newest first)
const allPosts = await getCollection('posts', ({ data }: CollectionEntry<'posts'>) => {
  return data.published !== false && data.archived !== true;
});

// Sort posts by slug (which contains date in Jekyll format YYYY-MM-DD)
const posts: CollectionEntry<'posts'>[] = allPosts.sort((a: CollectionEntry<'posts'>, b: CollectionEntry<'posts'>) => 
  b.slug.localeCompare(a.slug)
);

// Split into featured (top 3) and regular posts
const featuredPosts = posts.slice(0, 3);
const regularPosts = posts.slice(3);

// Get popular posts based on configured slugs
const popularPosts = popularPostSlugs
  .map(slug => allPosts.find((post: CollectionEntry<'posts'>) => post.slug === slug))
  .filter((post): post is CollectionEntry<'posts'> => post !== undefined);

// Helper function to get post metadata
function getPostMetadata(post: CollectionEntry<'posts'>) {
  const postDate = getDateFromSlug(post.slug);
  return {
    postUrl: getPostUrl(post.slug),
    date: formatPostDate(postDate),
    isoDate: formatISODate(postDate),
    readingTime: calculateReadingTime(post.body),
  };
}
---

<BaseLayout description={description} hero={true}>
  <!-- Popular Posts Section -->
  {popularPosts.length > 0 && (
    <section class="mb-12">
      <h2 class="text-2xl mb-6 section-header">
        <span class="section-header-accent"></span>
        Popular Posts
      </h2>
      <div class="row -mx-2">
        {popularPosts.map((post) => {
          const { postUrl, date, isoDate, readingTime } = getPostMetadata(post);
          return (
            <div class="w-full md:w-1/2 lg:w-1/3 px-2 mb-4">
              <FeaturedPostCard
                title={post.data.title}
                url={postUrl}
                date={date}
                isoDate={isoDate}
                description={post.data.description}
                readingTime={readingTime}
              />
            </div>
          );
        })}
      </div>
    </section>
  )}

  <!-- Recent Posts Section -->
  {featuredPosts.length > 0 && (
    <section class="mb-12">
      <h2 class="text-2xl mb-6 section-header">
        <span class="section-header-accent"></span>
        Recent Posts
      </h2>
      <div class="row -mx-2">
        {featuredPosts.map((post) => {
          const { postUrl, date, isoDate, readingTime } = getPostMetadata(post);
          return (
            <div class="w-full md:w-1/2 lg:w-1/3 px-2 mb-4">
              <FeaturedPostCard
                title={post.data.title}
                url={postUrl}
                date={date}
                isoDate={isoDate}
                description={post.data.description}
                readingTime={readingTime}
              />
            </div>
          );
        })}
      </div>
    </section>
  )}

  <!-- Older Posts Section -->
  {regularPosts.length > 0 && (
    <section>
      <h2 class="text-lg text-gray-600 dark:text-gray-400 mb-6 section-header">
        <span class="section-header-accent"></span>
        Older Posts
      </h2>
      <div class="row -mx-2">
        {regularPosts.map((post) => {
          const { postUrl, date, isoDate, readingTime } = getPostMetadata(post);
          return (
            <div class="w-full md:w-1/2 px-2 mb-3">
              <PostCard
                title={post.data.title}
                url={postUrl}
                date={date}
                isoDate={isoDate}
                description={post.data.description}
                readingTime={readingTime}
              />
            </div>
          );
        })}
      </div>
    </section>
  )}
</BaseLayout>
